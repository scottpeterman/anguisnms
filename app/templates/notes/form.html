{% extends "base.html" %}

{% block title %}{{ 'Edit Note' if note else 'Create Note' }} - Notes{% endblock %}

{% block head_extra %}
<script src="{{ url_for('static', filename='tinymce/js/tinymce/tinymce.min.js') }}"></script>
<style>
    .form-container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 24px;
    }

    .form-header {
        margin-bottom: 32px;
    }

    .form-header h1 {
        font: var(--md-typescale-headline-large);
        margin: 0 0 8px 0;
    }

    .form-group {
        margin-bottom: 24px;
    }

    .form-label {
        display: block;
        font: var(--md-typescale-title-medium);
        margin-bottom: 8px;
        color: var(--md-on-surface);
    }

    .form-label.required::after {
        content: ' *';
        color: var(--md-error);
    }

    .form-input,
    .form-select {
        width: 100%;
        padding: 12px 16px;
        font: var(--md-typescale-body-large);
        background: var(--md-surface-container);
        border: 1px solid var(--md-outline);
        border-radius: var(--md-shape-corner-medium);
        color: var(--md-on-surface);
        box-sizing: border-box;
    }

    .form-input:focus,
    .form-select:focus {
        outline: none;
        border-color: var(--md-primary);
        box-shadow: 0 0 0 3px rgba(103, 80, 164, 0.1);
    }

    .form-hint {
        font: var(--md-typescale-body-small);
        color: var(--md-on-surface-variant);
        margin-top: 4px;
    }

    .form-actions {
        display: flex;
        gap: 12px;
        margin-top: 32px;
        padding-top: 24px;
        border-top: 1px solid var(--md-outline-variant);
    }

    .md-button {
        padding: 10px 24px;
        border-radius: 20px;
        border: none;
        cursor: pointer;
        font-weight: 500;
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        gap: 8px;
        font: var(--md-typescale-label-large);
    }

    .md-button-filled {
        background: var(--md-primary);
        color: var(--md-on-primary);
    }

    .md-button-outlined {
        background: transparent;
        border: 1px solid var(--md-outline);
        color: var(--md-on-surface);
    }

    .md-button:hover {
        opacity: 0.9;
    }

    .association-fields {
        background: var(--md-surface-container-low);
        border: 1px solid var(--md-outline-variant);
        border-radius: var(--md-shape-corner-medium);
        padding: 20px;
        margin-top: 24px;
    }

    .association-fields h3 {
        font: var(--md-typescale-title-medium);
        margin: 0 0 16px 0;
    }

    /* TinyMCE dark mode support */
    body.dark-mode .tox-tinymce {
        border-color: var(--md-outline-variant) !important;
    }
</style>
{% endblock %}

{% block content %}
<div class="form-container">
    <div class="form-header">
        <h1>{{ 'Edit Note' if note else 'Create Note' }}</h1>
    </div>

    <form method="POST" id="noteForm">
        <div class="form-group">
            <label for="title" class="form-label required">Title</label>
            <input
                type="text"
                id="title"
                name="title"
                class="form-input"
                placeholder="Enter note title"
                value="{{ note.title if note else (form_data.title if form_data else '') }}"
                required
                autofocus
            >
        </div>

        <div class="form-group">
            <label for="note_type" class="form-label">Type</label>
            <select id="note_type" name="note_type" class="form-select">
                {% set current_type = note.note_type if note else (form_data.note_type if form_data else 'general') %}
                <option value="general" {{ 'selected' if current_type == 'general' }}>General</option>
                <option value="site" {{ 'selected' if current_type == 'site' }}>Site</option>
                <option value="device" {{ 'selected' if current_type == 'device' }}>Device</option>
                <option value="kb" {{ 'selected' if current_type == 'kb' }}>Knowledge Base</option>
                <option value="incident" {{ 'selected' if current_type == 'incident' }}>Incident</option>
                <option value="maintenance" {{ 'selected' if current_type == 'maintenance' }}>Maintenance</option>
            </select>
        </div>

        <div class="form-group">
            <label for="tags" class="form-label">Tags</label>
            <input
                type="text"
                id="tags"
                name="tags"
                class="form-input"
                placeholder="network, cisco, troubleshooting (comma-separated)"
                value="{{ tags_str if tags_str is defined else (form_data.tags if form_data else '') }}"
            >
            <div class="form-hint">Comma-separated tags for categorization</div>
        </div>

        <div class="form-group">
            <label for="content" class="form-label required">Content</label>
            <textarea
                id="content"
                name="content"
                rows="20"
            >{{ note.content if note else (form_data.content if form_data else '') }}</textarea>
        </div>

        {% if device_id or site_code %}
        <div class="association-fields">
            <h3>
                <i data-lucide="link" size="18"></i>
                Associations
            </h3>
            {% if device_id %}
            <input type="hidden" name="device_id" value="{{ device_id }}">
            <div class="form-hint">Will be linked to Device ID: {{ device_id }}</div>
            {% endif %}
            {% if site_code %}
            <input type="hidden" name="site_code" value="{{ site_code }}">
            <div class="form-hint">Will be linked to Site: {{ site_code }}</div>
            {% endif %}
        </div>
        {% endif %}

        <div class="form-actions">
            <button type="submit" class="md-button md-button-filled">
                <i data-lucide="save" size="16"></i>
                {{ 'Update Note' if note else 'Create Note' }}
            </button>
            <a href="{{ url_for('notes.index') }}" class="md-button md-button-outlined">
                <i data-lucide="x" size="16"></i>
                Cancel
            </a>
        </div>
    </form>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Initialize Lucide icons
    if (typeof lucide !== 'undefined') {
        lucide.createIcons();
    }

    // Initialize TinyMCE
    tinymce.init({
        selector: '#content',
        license_key: 'gpl',
        height: 500,
        menubar: true,
        plugins: [
            'advlist', 'autolink', 'lists', 'link', 'image', 'charmap', 'preview',
            'anchor', 'searchreplace', 'visualblocks', 'code', 'fullscreen',
            'insertdatetime', 'media', 'table', 'help', 'wordcount', 'codesample'
        ],
        toolbar: 'undo redo | blocks | ' +
            'bold italic forecolor | alignleft aligncenter ' +
            'alignright alignjustify | bullist numlist outdent indent | ' +
            'link image media table codesample | ' +
            'removeformat code fullscreen help',

        // Content styling
        content_style: 'body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; font-size: 14px; line-height: 1.6; }',

        // Image upload handling
        images_upload_handler: function (blobInfo, progress) {
            return new Promise(function(resolve, reject) {
                const formData = new FormData();
                formData.append('file', blobInfo.blob(), blobInfo.filename());

                // Get note_id from URL if editing
                const urlParams = new URLSearchParams(window.location.search);
                const noteId = window.location.pathname.match(/\/notes\/(\d+)/)?.[1];

                if (!noteId) {
                    reject('Please save the note first before uploading images');
                    return;
                }

                fetch(`/notes/${noteId}/upload`, {
                    method: 'POST',
                    body: formData
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        resolve(data.url);
                    } else {
                        reject(data.error || 'Upload failed');
                    }
                })
                .catch(error => {
                    reject('Upload failed: ' + error);
                });
            });
        },

        // Code sample languages
        codesample_languages: [
            { text: 'Python', value: 'python' },
            { text: 'JavaScript', value: 'javascript' },
            { text: 'HTML/XML', value: 'markup' },
            { text: 'CSS', value: 'css' },
            { text: 'Shell', value: 'shell' },
            { text: 'SQL', value: 'sql' },
            { text: 'JSON', value: 'json' },
            { text: 'YAML', value: 'yaml' },
        ],

        // Link target options
        link_target_list: [
            { title: 'None', value: '' },
            { title: 'New window', value: '_blank' }
        ],

        // Custom format for internal links
        setup: function(editor) {
            // Add internal link button
            editor.ui.registry.addButton('internallink', {
                icon: 'bookmark',
                tooltip: 'Insert internal note link',
                onAction: function() {
                    editor.windowManager.open({
                        title: 'Link to Another Note',
                        body: {
                            type: 'panel',
                            items: [{
                                type: 'input',
                                name: 'noteTitle',
                                label: 'Note Title',
                                placeholder: 'Start typing note title...'
                            }]
                        },
                        buttons: [
                            {
                                type: 'cancel',
                                text: 'Cancel'
                            },
                            {
                                type: 'submit',
                                text: 'Insert Link',
                                primary: true
                            }
                        ],
                        onSubmit: function(api) {
                            const data = api.getData();
                            editor.insertContent(`[[${data.noteTitle}]]`);
                            api.close();
                        }
                    });
                }
            });

            // Add to toolbar
            editor.on('init', function() {
                // Toolbar already configured above
            });
        },

        // Prevent TinyMCE from stripping internal link syntax
        valid_children: '+body[style]',
        extended_valid_elements: 'span[*]',

        // Preserve internal link format
        protect: [
            /\[\[.*?\]\]/g  // Protect [[Note Title]] syntax
        ]
    });

    // Form submission handler
    document.getElementById('noteForm').addEventListener('submit', function(e) {
        // TinyMCE automatically updates the textarea
        // No additional handling needed
    });
});
</script>
{% endblock %}